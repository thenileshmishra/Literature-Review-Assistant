name: Deploy

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::143873723946:role/github-actions-ecr-ecs-role
          aws-region: us-east-1

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Backend
        run: |
          BACKEND_URI=143873723946.dkr.ecr.us-east-1.amazonaws.com/agent_autogen_backend
          docker build -t $BACKEND_URI:latest ./backend
          docker push $BACKEND_URI:latest

      - name: Build & Push Frontend
        run: |
          FRONTEND_URI=143873723946.dkr.ecr.us-east-1.amazonaws.com/agent_autogen_frontend
          docker build -t $FRONTEND_URI:latest ./frontend
          docker push $FRONTEND_URI:latest

      - name: Copy Nginx Config to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: nginx-http.conf
          target: ~/

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: OPENAI_API_KEY
          script: |
            BACKEND_URI=143873723946.dkr.ecr.us-east-1.amazonaws.com/agent_autogen_backend
            FRONTEND_URI=143873723946.dkr.ecr.us-east-1.amazonaws.com/agent_autogen_frontend

            aws ecr get-login-password --region us-east-1 | \
            docker login --username AWS --password-stdin 143873723946.dkr.ecr.us-east-1.amazonaws.com

            docker pull $BACKEND_URI:latest
            docker pull $FRONTEND_URI:latest

            # Stop all app containers
            docker stop backend frontend nginx 2>/dev/null || true
            docker rm backend frontend nginx 2>/dev/null || true

            # Kill any host-level process using port 80 (e.g. system nginx)
            sudo fuser -k 80/tcp 2>/dev/null || true

            docker network create app-network 2>/dev/null || true

            docker run -d --name backend \
              --network app-network \
              --restart unless-stopped \
              -e OPENAI_API_KEY="$OPENAI_API_KEY" \
              -e CORS_ORIGINS='["http://agent.nileshmishra.info","https://agent.nileshmishra.info"]' \
              $BACKEND_URI:latest

            docker run -d --name frontend \
              --network app-network \
              --restart unless-stopped \
              $FRONTEND_URI:latest

            docker run -d --name nginx \
              --network app-network \
              --restart unless-stopped \
              -p 80:80 \
              -v ~/nginx-http.conf:/etc/nginx/conf.d/default.conf:ro \
              nginx:alpine
